<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>JavaScript Quiz</title>
  <link rel="icon" href="icons/Logo.jpg">
  <style>
    body {
      font-family: Arial, sans-serif;
      line-height: 1.6;
      margin: 0;
      padding: 20px;
      background-color: #f5f5f5;
    }
    .sidebar3 {
      position: fixed;
      left: 20px; top: 20px;
    }
    .sidebar3 a {
      display: inline-block;
      padding: 10px 15px;
      background-color: #4CAF50;
      color: white;
      text-decoration: none;
      border-radius: 5px;
    }
    .sidebar3 a:hover { background-color: #45a049; }
    .main-right {
      margin-left: 100px;
      max-width: 800px;
    }
    .quiz {
      background: white;
      padding: 20px;
      margin-bottom: 30px;
      border-radius: 8px;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    }
    .quiz h2 {
      color: #333;
      margin-top: 0;
    }
    .question {
      margin-bottom: 20px;
    }
    .question h4 {
      margin: 0 0 8px;
      font-weight: bold;
    }
    .answer {
      margin: 0 0 16px;
      padding-left: 8px;
    }
    .options {
      margin-left: 20px;
    }
    .option {
      margin: 8px 0;
      cursor: pointer;
      padding: 8px;
      border-radius: 4px;
    }
    .option:hover { background-color: #f0f0f0; }
    .option.selected { background-color: #d4edda; }
    .option.correct  { background-color: #d4edda; font-weight: bold; }
    .option.incorrect{ background-color: #f8d7da; }
    button {
      background: #4CAF50;
      color: white;
      border: none;
      padding: 10px 15px;
      border-radius: 4px;
      cursor: pointer;
      font-size: 16px;
      margin-top: 10px;
    }
    button:hover { background-color: #45a049; }
    .results {
      margin-top: 20px;
      padding: 15px;
      background: #e7f3fe;
      border-radius: 4px;
      display: none;
    }
    .answer-key {
      margin-top: 20px;
      padding: 15px;
      background: #f8f9fa;
      border-radius: 4px;
      display: none;
    }
    .score {
      font-size: 18px; font-weight: bold;
      margin-bottom: 10px;
    }
    pre {
      background: #f8f9fa;
      padding: 10px;
      border-radius: 4px;
      overflow-x: auto;
    }
  </style>
</head>
<body>
  <div class="sidebar3">
    <a href="index.html">Go Back</a>
  </div>
  <main class="main-right">
    <div id="quiz1" class="quiz"></div>
  </main>
  <script>
    document.addEventListener("DOMContentLoaded", function() {
      // rule-based feedback
      function getFeedback(score, total) {
        const pct = (score/total)*100;
        if (pct === 100) return "🌟 Perfect! You nailed it!";
        if (pct >= 80)  return "✅ Great job! A little more review and you'll be perfect.";
        if (pct >= 50)  return "📝 Good effort! Keep practicing and you'll improve!";
        return "📚 Let's review the material again and try once more!";
      }

      // load context & lesson
      const ctx = JSON.parse(localStorage.getItem("currentQuizContext")||"{}");
      if (!ctx.lessonId) { window.location.href="index.html"; return; }
      const lesson = JSON.parse(localStorage.getItem("currentLesson")||"{}");
      if (!lesson.content) {
        alert("No quiz for this lesson."); window.location.href="index.html"; return;
      }

      let content = lesson.content;
      if (typeof content === "string") content = JSON.parse(content);
      const quizBlock = (content.contentBlocks||[]).find(b=>b.type==="quiz");
      if (!quizBlock) {
        alert("No quiz in this lesson."); window.location.href="index.html"; return;
      }

      // derive title "Lesson X Quiz"
      let title = quizBlock.title;
      if (title.startsWith("Quiz:")) {
        title = title.split(":")[1].trim() + " Quiz";
      }

      const container = document.getElementById("quiz1");
      container.innerHTML = "<h2>" + title + "</h2>";

      // parse raw HTML
      const tmp = document.createElement("div");
      tmp.innerHTML = quizBlock.content;
      const lis = Array.from(tmp.querySelectorAll("ol>li"));
      const isMCQ = lis.some(li=> li.querySelector("ul"));

      if (!isMCQ) {
        // Q&A style
        lis.forEach(function(li,i){
          const qText = li.childNodes[0].textContent.trim();
          const em = li.querySelector("em");
          let ans = "";
          if (em && em.nextSibling) ans = em.nextSibling.textContent.trim();
          const qDiv = document.createElement("div");
          qDiv.className = "question";
          qDiv.innerHTML =
            "<h4>" + (i+1) + ". " + qText + "</h4>" +
            "<div class='answer'>" + ans + "</div>";
          container.appendChild(qDiv);
        });
        return;
      }

      // MCQ style
      // collect correct answers
      const answerKey = [];
      lis.forEach(li=>{
        li.querySelectorAll("ul>li").forEach(opt=>{
          if (opt.querySelector("strong")) {
            answerKey.push(opt.textContent.trim());
          }
        });
      });

      // render questions
      lis.forEach(function(li,i){
        const qText = li.childNodes[0].textContent.trim();
        const qDiv = document.createElement("div");
        qDiv.className = "question";
        qDiv.innerHTML = "<h4>" + (i+1) + ". " + qText + "</h4>";

        // clone any code snippets
        li.querySelectorAll("pre").forEach(function(pre){
          qDiv.appendChild(pre.cloneNode(true));
        });

        // options
        const optsContainer = document.createElement("div");
        optsContainer.className = "options";
        li.querySelectorAll("ul>li").forEach(function(optLi){
          const text = optLi.textContent.trim();
          const correct = !!optLi.querySelector("strong");
          const odiv = document.createElement("div");
          odiv.className = "option";
          odiv.dataset.correct = correct;
          odiv.textContent = text;
          odiv.addEventListener("click", function(){
            optsContainer.querySelectorAll(".option")
              .forEach(o=>o.classList.remove("selected"));
            odiv.classList.add("selected");
          });
          optsContainer.appendChild(odiv);
        });
        qDiv.appendChild(optsContainer);
        container.appendChild(qDiv);
      });

      // append submit/results/answer-key
      container.insertAdjacentHTML("beforeend",
        '<button class="submit-btn">Submit Quiz</button>' +
        '<div class="results"></div>' +
        '<div class="answer-key">' +
          '<h3>Answer Key:</h3>' +
          '<p>' + answerKey.map((a,i)=> (i+1) + ' – ' + a).join(', ') + '</p>' +
        '</div>'
      );

      const submitBtn    = container.querySelector(".submit-btn");
      const resultsDiv   = container.querySelector(".results");
      const answerKeyDiv = container.querySelector(".answer-key");

      submitBtn.addEventListener("click", function(){
        let score = 0;
        const questions = container.querySelectorAll(".question");
        questions.forEach(function(qDiv){
          const opts = qDiv.querySelectorAll(".option");
          opts.forEach(function(o){
            if (o.dataset.correct==="true") o.classList.add("correct");
          });
          const sel = qDiv.querySelector(".option.selected");
          if (sel) {
            if (sel.dataset.correct==="true") score++;
            else sel.classList.add("incorrect");
          }
        });

        const total = questions.length;
        resultsDiv.style.display = "block";
        resultsDiv.innerHTML =
          '<div class="score">You scored ' + score + ' out of ' + total + '</div>' +
          '<div class="feedback-local">' + getFeedback(score,total) + '</div>' +
          '<div class="feedback-ai">💬 Fetching AI feedback…</div>';
        answerKeyDiv.style.display = "block";

        fetch("http://localhost:5000/chat", {
          method:"POST",
          headers:{"Content-Type":"application/json"},
          body: JSON.stringify({score,total,topic:title})
        })
        .then(r=>r.json())
        .then(js=>{
          resultsDiv.querySelector(".feedback-ai").innerText = js.response;
        })
        .catch(()=>{
          const aiDiv = resultsDiv.querySelector(".feedback-ai");
          aiDiv.innerText = "Error fetching AI feedback";
          aiDiv.style.color = "red";
        });
      });

    });
  </script>
</body>
</html>
